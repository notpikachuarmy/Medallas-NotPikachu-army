<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Perfil de Usuario</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 2rem; }
        header { margin-bottom: 2rem; }
        img.avatar { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 1rem; }
        .medalla { display: inline-block; background: white; border-radius: 8px; padding: 1rem; margin: 0.5rem; width: 150px; vertical-align: top; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .medalla img { width: 100px; height: 100px; display: block; margin: 0 auto 0.5rem auto; }
        #filterControls { margin-bottom: 1rem; }
        #filterControls select { padding: 0.5rem; font-size: 1rem; }
    </style>
</head>
<body>
    <header>
        <a href="index.html">⬅ Volver</a>
        <h1 id="username">Usuario</h1>
    </header>

    <div id="filterControls">
        <label for="medalRarity">Filtrar por rareza:</label>
        <select id="medalRarity">
            <option value="">Todas</option>
        </select>
    </div>

    <main id="userMedals">
        <p>Cargando medallas...</p>
    </main>

    <script>
    const MEDALS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1uxeXCUyWi2kLAWEGJjZ91zutr18sr7_QjHqxfPVzgCA/export?format=csv&gid=0';
    const USERS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1Pri9HhHGipD08e847iUKruXPLzG9tWki3N5rQPu2cMw/export?format=csv&gid=0';

    let allMedals = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadUserProfile();
    });

    function fixImgurLink(url) {
        url = url.trim();
        if (!url) return '';
        if (url.includes("imgur.com/a/") || url.includes("imgur.com/gallery/")) {
            let id = url.split("/").pop();
            return `https://i.imgur.com/${id}.png`;
        }
        if (url.includes("imgur.com") && !url.includes("i.imgur.com")) {
            let id = url.split("/").pop().split(".")[0];
            return `https://i.imgur.com/${id}.png`;
        }
        return url;
    }

    function loadUserProfile() {
        const params = new URLSearchParams(window.location.search);
        const user = params.get('user');
        document.getElementById('username').textContent = user || 'Usuario';

        const container = document.getElementById('userMedals');
        container.innerHTML = '<p>Cargando medallas...</p>';

        Promise.all([
            fetch(MEDALS_SHEET_URL).then(res => res.text()),
            fetch(USERS_SHEET_URL).then(res => res.text())
        ]).then(([medalsData, usersData]) => {
            const medalRows = medalsData.split('\n').map(r => r.split(','));
            const userRows = usersData.split('\n').map(r => r.split(','));

            // Cargar todas las medallas
            allMedals = medalRows.slice(1).map(r => ({
                id: r[0]?.trim(),
                nombre: r[1]?.trim(),
                rareza: r[2]?.trim(),
                imagenURL: fixImgurLink(r[3]?.trim()),
                descripcion: r[4]?.trim()
            })).filter(m => m.nombre && m.imagenURL);

            // Encontrar medallas del usuario
            let userMedalsIDs = [];
            let userAvatar = '';

            for (let i = 1; i < userRows.length; i++) {
                const [discordID, username, avatarURL, medalsStr] = userRows[i];
                if (!username || !medalsStr) continue;
                if (username.trim().toLowerCase() === (user || '').toLowerCase()) {
                    userAvatar = avatarURL?.trim() || '';
                    medalsStr.split(',').forEach(medalID => userMedalsIDs.push(medalID.trim()));
                }
            }

            container.innerHTML = '';

            // Mostrar avatar
            if (userAvatar) {
                const avatarImg = document.createElement('img');
                avatarImg.src = userAvatar;
                avatarImg.alt = user;
                avatarImg.className = 'avatar';
                container.appendChild(avatarImg);
            }

            // Filtrar medallas del usuario y ordenar por rareza
            const rarityOrder = ['Legendaria', 'Épica', 'Rara', 'Común']; // Ajusta según tu CSV
            let userMedals = allMedals.filter(m => userMedalsIDs.includes(m.id));
            userMedals.sort((a, b) => (rarityOrder.indexOf(a.rareza) || 99) - (rarityOrder.indexOf(b.rareza) || 99));

            // Llenar select de rareza
            const raritySelect = document.getElementById('medalRarity');
            const raritySet = new Set(userMedals.map(m => m.rareza).filter(Boolean));
            raritySet.forEach(r => {
                if (![...raritySelect.options].some(o => o.value === r)) {
                    const option = document.createElement('option');
                    option.value = r;
                    option.textContent = r;
                    raritySelect.appendChild(option);
                }
            });

            function renderMedals(filter = '') {
                container.querySelectorAll('.medalla').forEach(e => e.remove());
                let medalsToShow = userMedals;
                if (filter) medalsToShow = userMedals.filter(m => m.rareza === filter);
                if (medalsToShow.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = 'No se encontraron medallas.';
                    container.appendChild(p);
                    return;
                }

                medalsToShow.forEach(({nombre, rareza, imagenURL, descripcion}) => {
                    const item = document.createElement('div');
                    item.className = 'medalla';

                    const img = document.createElement('img');
                    img.src = imagenURL;
                    img.alt = nombre;

                    const title = document.createElement('strong');
                    title.textContent = nombre;

                    const desc = document.createElement('p');
                    desc.textContent = descripcion || '';

                    item.appendChild(img);
                    item.appendChild(title);
                    item.appendChild(desc);
                    container.appendChild(item);
                });
            }

            renderMedals();

            // Filtrar rareza
            raritySelect.addEventListener('change', () => renderMedals(raritySelect.value));

        }).catch(err => {
            console.error('Error cargando perfil:', err);
            container.innerHTML = '<p>Error cargando medallas</p>';
        });
    }
    </script>
</body>
</html>
